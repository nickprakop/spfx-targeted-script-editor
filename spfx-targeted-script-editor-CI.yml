# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
 branches:
  include:
    - main
    - develop
    - acceptance
 paths:
  include:
     - src/** 

variables:
  packageName: 'spfx-targeted-script-editor'
 
stages:
  - stage: Build
    jobs:
      - job:
        pool:
          vmImage: ubuntu-latest

        steps:
        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'
          displayName: 'Install Node.js'

        - script: npm install    
          displayName: 'npm install'

        - script: gulp bundle --ship
          displayName: 'gulp bundle'

        - script: gulp package-solution --ship
          displayName: 'gulp package-solution'

        - task: CopyFiles@2
          inputs:
            contents: '**/*.sppkg'
            TargetFolder: '$(Build.ArtifactStagingDirectory)/$(packageName)'
            flattenFolders: true
        - task: PublishBuildArtifacts@1
          inputs:
           PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(packageName)'
           ArtifactName: $(packageName)

  - stage: Deploy
    displayName: 'Release to Dev site'
    condition: succeeded('Build')
    variables:
    - group: 'Develop environment'
    jobs:
    - deployment: 
      displayName: 'Deployment job'
      environment: 'Development'
      strategy:
       runOnce:
         deploy:
          steps:
            - task: PowerShell@2
              continueOnError: false
              inputs:
                pwsh: true
                targetType: 'inline'
                script: |
                  # Install the PnP PowerShell module
                  Install-Module -Name PnP.PowerShell -Force -AllowClobber -Scope CurrentUser
                  # Connect to SharePoint Online using App-Only authentication
                  $securePassword = ConvertTo-SecureString -String $env:SPO_CLIENT_SECRET -AsPlainText -Force
                  Connect-PnPOnline -Url $env:SPO_SITE_URL -ClientId $env:SPO_CLIENT_ID -Tenant $env:SPO_TENANT_ID -ClientSecret $securePassword

                  # Upload the .sppkg file to the App Catalog
                  Add-PnPApp -Path ./sharepoint/solution/your-solution.sppkg -Overwrite
                  # Deploy the app in the App Catalog
                  Install-PnPApp -Identity (Get-PnPApp -Scope Tenant -AppId "your-sppkg-app-id") -Scope Tenant
              displayName: 'Deploy SPFx solution to SharePoint Online'
                  